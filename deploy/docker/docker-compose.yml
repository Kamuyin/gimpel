version: "3.9"

services:
  bootstrap-init:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.tools
    image: gimpel-tools:dev
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        if [ ! -f /keys/signing.pub ]; then
          /app/gimpel-sign generate-key --output /keys --name signing
        fi
        if [ ! -f /certs/ca.crt ]; then
          openssl genrsa -traditional -out /certs/ca.key 2048;
          openssl req -x509 -new -key /certs/ca.key \
            -out /certs/ca.crt -days 3650 -subj "/CN=gimpel-ca";
        fi
        if [ ! -f /certs/master.key ]; then
          openssl genrsa -traditional -out /certs/master.key 2048;
          openssl req -new -key /certs/master.key \
            -out /certs/master.csr -subj "/CN=master";
          printf "subjectAltName=DNS:master\nextendedKeyUsage=serverAuth\n" > /certs/master.ext;
          openssl x509 -req -in /certs/master.csr \
            -CA /certs/ca.crt -CAkey /certs/ca.key -CAcreateserial \
            -out /certs/master.crt -days 3650 -sha256 \
            -extfile /certs/master.ext;
          rm -f /certs/master.csr /certs/master.ext /certs/ca.srl;
        fi
        if [ ! -f /certs/gateway.key ]; then
          openssl genrsa -traditional -out /certs/gateway.key 2048;
          openssl req -new -key /certs/gateway.key \
            -out /certs/gateway.csr -subj "/CN=gateway";
          printf "subjectAltName=DNS:gateway\nextendedKeyUsage=serverAuth\n" > /certs/gateway.ext;
          openssl x509 -req -in /certs/gateway.csr \
            -CA /certs/ca.crt -CAkey /certs/ca.key -CAcreateserial \
            -out /certs/gateway.crt -days 3650 -sha256 \
            -extfile /certs/gateway.ext;
          rm -f /certs/gateway.csr /certs/gateway.ext /certs/ca.srl;
        fi
        TOKEN=""
        while [ -z "$$TOKEN" ]; do
          RESP=$(curl -sf -X POST http://master:8080/api/v1/pairings \
            -H 'Content-Type: application/json' \
            -d '{"ttl_seconds":600}') || true
          if [ -n "$$RESP" ]; then
            TOKEN=$(printf '%s' "$$RESP" | sed -n 's/.*"token":"\([^"]*\)".*/\1/p')
            if [ -z "$$TOKEN" ]; then
              echo "pairing response: $$RESP" >&2
            fi
          fi
          if [ -z "$$TOKEN" ]; then
            sleep 1
          fi
        done
        mkdir -p /pairing
        echo "$$TOKEN" > /pairing/token
    volumes:
      - signing-keys:/keys
      - tls-certs:/certs
      - pairing-token:/pairing
    networks:
      - gimpel
    restart: "no"

  master:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.master
    image: gimpel-master:dev
    ports:
      - "9090:9090"
      - "8080:8080"
    volumes:
      - master-data:/var/lib/gimpel-master
      - signing-keys:/var/lib/gimpel-master/keys
      - tls-certs:/var/lib/gimpel-certs:ro
      - ./config/master.yaml:/etc/gimpel/master.yaml:ro
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        while [ ! -f /var/lib/gimpel-master/keys/signing.pub ] || \
              [ ! -f /var/lib/gimpel-certs/ca.crt ] || \
              [ ! -f /var/lib/gimpel-certs/master.crt ] || \
              [ ! -f /var/lib/gimpel-certs/master.key ]; do
          sleep 1
        done
        exec /app/gimpel-master -config /etc/gimpel/master.yaml
    networks:
      - gimpel

  gateway:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.gateway
    image: gimpel-gateway:dev
    depends_on:
      - kafka
    ports:
      - "8081:8081"
    environment:
      KAFKA_BROKERS: "kafka:9092"
    volumes:
      - ./config/gateway.yaml:/etc/gimpel/gateway.yaml:ro
      - master-data:/var/lib/gimpel-master:ro
      - tls-certs:/var/lib/gimpel-certs:ro
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        while [ ! -f /var/lib/gimpel-certs/gateway.crt ] || \
              [ ! -f /var/lib/gimpel-certs/gateway.key ]; do
          sleep 1
        done
        exec /app/gimpel-gateway -config /etc/gimpel/gateway.yaml
    networks:
      - gimpel

  sandbox:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.sandbox
    image: gimpel-sandbox:dev
    ports:
      - "5000:5000"
    volumes:
      - ./config/sandbox.yaml:/etc/gimpel/sandbox.yaml:ro
    command: ["/app/gimpel-sandbox", "-config", "/etc/gimpel/sandbox.yaml"]
    networks:
      - gimpel

  agent:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.agent
    image: gimpel-agent:dev
    depends_on:
      - master
      - gateway
      - bootstrap-init
    entrypoint: ["/bin/sh", "-ec"]
    volumes:
      - /var/lib/gimpel
      - signing-keys:/keys:ro
      - master-data:/var/lib/gimpel-master:ro
      - tls-certs:/var/lib/gimpel-certs:ro
      - pairing-token:/pairing:ro
      - ./config/agent.yaml:/etc/gimpel/agent.yaml:ro
    command:
      - |
        if [ ! -f /var/lib/gimpel/cert.pem ]; then
          while [ ! -s /pairing/token ]; do
            sleep 1
          done
          TOKEN=$(cat /pairing/token)
          if [ -z "$$TOKEN" ]; then
            echo "missing pairing token" >&2
            exit 1
          fi
          /app/gimpel-agent -config /etc/gimpel/agent.yaml --pair --pair-token "$$TOKEN"
        fi
        exec /app/gimpel-agent -config /etc/gimpel/agent.yaml
    networks:
      - gimpel

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - gimpel

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    networks:
      - gimpel

networks:
  gimpel:
    driver: bridge

volumes:
  master-data:
  signing-keys:
  tls-certs:
  pairing-token:
